---
title: "lab4_transcriptomics"
author: "Ilay Jacques Paz"
date: "2025-09-25"
output: html_document
---


QUESTION 1
```{r}
#e.g.1 get the path 
fq_path <- systemPipeRdata::pathList()$fastqdir

#e.g.2 list the files 

fq_files <- list.files(fq_path)

print(fq_files)
meta_data <- read.table(
  "/Users/ipaz00/Library/R/arm64/4.4/library/systemPipeRdata/extdata/param/targetsPE.txt", 
  header = TRUE)
head(meta_data)

#RENAMING THE FILE 
library(biomaRt)
library(DT)

# Step 1: Get fastq path and file list (optional, for context)
fq_path <- systemPipeRdata::pathList()$fastqdir
fq_files <- list.files(fq_path)
print(fq_files)

# Step 2: Read the original metadata file (unaltered)
file_path <- "/Users/ipaz00/Library/R/arm64/4.4/library/systemPipeRdata/extdata/param/targetsPE.txt"
meta_data <- read.table(file_path, header = TRUE, stringsAsFactors = FALSE)
head(meta_data)

# Step 3: Simulate replacements IN MEMORY (no file is overwritten!)
file_content <- readLines(file_path)

# Replace *_1.fastq.gz → .fna path (just for display)
file_content_modified <- gsub(
  pattern = "\\./data/SRR446[0-9]+_1\\.fastq\\.gz",
  replacement = "/Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/GCF_000001735.4_TAIR10.1_genomic.fna",
  x = file_content
)

# Replace *_2.fastq.gz → .gtf path (just for display)
file_content_modified <- gsub(
  pattern = "\\./data/SRR446[0-9]+_2\\.fastq\\.gz",
  replacement = "/Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/GCF_000001735.4_TAIR10.1_genomic.gtf",
  x = file_content_modified
)

# Convert modified content into a data frame (skip comments if needed)
meta_data_modified <- read.table(
  text = file_content_modified, 
  header = TRUE, 
  stringsAsFactors = FALSE
)

#CREATING THE DATA TABE
datatable(meta_data_modified)

```
QUESTION 2
```{r}
library(Rqc)
fastq_files <- unique(c(meta_data$FileName1, meta_data$FileName2))
qcRes <- rqc(path=fq_path, pattern = ".fastq.gz")
rqcCycleQualityBoxPlot(qcRes)
rqcReadFrequencyPlot(qcRes)


rqcCycleQualityBoxPlot(qcRes[0:12])
rqcCycleQualityBoxPlot(qcRes[13:24])
rqcCycleQualityBoxPlot(qcRes[25:36])

rqcReadFrequencyPlot(qcRes[0:12])
rqcReadFrequencyPlot(qcRes[13:24])
rqcReadFrequencyPlot(qcRes[25:36])

```

QUESTION 3
```{r}
file.exists("processed_reads/M1A_processed.fastq.gz")
file.remove("processed_reads/M1A_processed.fastq.gz")
library(ShortRead)
targets_data <- read.table(
  "/Users/ipaz00/Library/R/arm64/4.4/library/systemPipeRdata/extdata/param/targetsPE.txt",
  header = TRUE,stringsAsFactors = FALSE)
fastq_dir <- "/Users/ipaz00/Library/R/arm64/4.4/library/systemPipeRdata/extdata/fastq"
targets_data$FileName1 <- file.path(fastq_dir, basename(targets_data$FileName1))
targets_data$FileName2 <- file.path(fastq_dir, basename(targets_data$FileName2))
output_dir <- "processed_reads"
if (!dir.exists(output_dir)) dir.create(output_dir)
adapter_seq <- "GCCCGGGTAA"

process_read_file <- function(input_path, sample_name) {
  output_file <- file.path(output_dir, paste0(sample_name, "_processed.fastq.gz"))
  fq <- readFastq(input_path)
  trimmed_seq <- trimLRPatterns(Lpattern = adapter_seq, subject = sread(fq), max.Lmismatch = 0)
  keep_idx <- width(trimmed_seq) > 0
  fq <- fq[keep_idx]
  trimmed_seq <- trimmed_seq[keep_idx]
  trimmed_seq <- narrow(trimmed_seq, end = width(trimmed_seq) - 3)
  trimmed_qual <- narrow(quality(fq), end = width(trimmed_seq))
  fq <- ShortReadQ(sread = trimmed_seq, quality = trimmed_qual, id = ShortRead::id(fq)[keep_idx])
  
  if(length(fq) == 0) {
    if(file.exists(output_file)) file.remove(output_file)
    writeFastq(fq, output_file, compress = TRUE, mode="w")
    return(output_file)
  }
  
  afreq <- alphabetFrequency(sread(fq), baseOnly = TRUE)
  if(!"N" %in% colnames(afreq)) {
    keep_noN <- rep(TRUE, length(fq))
  } else {
    keep_noN <- afreq[, "N"] <= 1
  }
  fq <- fq[keep_noN]
  
  if(file.exists(output_file)) file.remove(output_file)   # <-- add this line to avoid error
  writeFastq(fq, output_file, compress = TRUE, mode="w")
  return(output_file)
}


processed_reads <- mapply(
  FUN = process_read_file,
  input_path = targets_data$FileName1,
  sample_name = targets_data$SampleName,
  SIMPLIFY = TRUE
)

targets_data$ProcessedFile1 <- processed_reads

DT::datatable(targets_data)

```
QUESTION 4
Convert fastq into SAM 
```{bash}
 for fq in /Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/processed_reads/*_processed.fastq; do   base=$(basename "$fq" | sed 's/_processed.fastq//');   hisat2 -x /Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/hisat2_index/tair10_1_index     -U "$fq"     -p 8     -S sam_files/"$base".sam; done
```
Convert SAM into BAM and BAM sorted
```{r}
sam_dir <- "/Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/sam_files"
bam_dir <- "/Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/bam_files"
fastq_dir <- "/Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/processed_reads"
hisat2_index <- "/Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/hisat2_index/tair10_1_index"

meta_data <- read.table("/Users/ipaz00/Library/R/arm64/4.4/library/systemPipeRdata/extdata/param/targetsPE.txt", header = TRUE, stringsAsFactors = FALSE)

for (sample_name in meta_data$SampleName) {
  fastq_file <- file.path(fastq_dir, paste0(sample_name, "_processed.fastq"))
  sam_file <- file.path(sam_dir, paste0(sample_name, ".sam"))

  if (!file.exists(fastq_file)) {
    message("Skipping ", sample_name, ": FASTQ file not found - ", fastq_file)
    next
  }

  hisat2_log <- tryCatch({
    system2("hisat2", args = c("-x", hisat2_index, "-U", fastq_file, "-S", sam_file), stdout = TRUE, stderr = TRUE)
  }, error = function(e) paste("hisat2 failed:", e$message))
  writeLines(hisat2_log, file.path(bam_dir, paste0(sample_name, "_hisat2.log")))

  bam_file <- file.path(bam_dir, paste0(sample_name, ".bam"))
  sorted_bam_file <- file.path(bam_dir, paste0(sample_name, "_sorted.bam"))

  system2("samtools", args = c("view", "-bS", sam_file, "-o", bam_file))
  system2("samtools", args = c("sort", "-o", sorted_bam_file, bam_file))
  system2("samtools", args = c("index", sorted_bam_file))

  cat("Finished processing sample:", sample_name, "\n")
}

```

QUESTION 5
```{r}
library(dplyr)
library(stringr)
library(DT)
library(ggplot2)
bam_dir <- "/Users/ipaz00/Downloads/BIOL4315_R/biol4315lab4/BIOL-4315-lab4/bam_files"
log_files <- list.files(bam_dir, pattern = "_hisat2\\.log$", full.names = TRUE)
log_sample_names <- basename(log_files) %>%
str_remove("_hisat2\\.log$") %>%
sort()
percent_aligned <- vector("character", length(log_files))
for (i in seq_along(log_files)) {
  lines <- readLines(log_files[i])
  matched_line <- grep("overall alignment rate", lines, value = TRUE)
  if(length(matched_line) == 1) {
    percent_aligned[i] <- matched_line
  } else {
    percent_aligned[i] <- NA
  }
}
align_df <- data.frame(
  samplename = log_sample_names,
  percent_aligned = percent_aligned,
  stringsAsFactors = FALSE)

align_df <- align_df %>%
  mutate(
    percent_aligned = as.numeric(str_extract(percent_aligned, "\\d+\\.?\\d*")))

head(align_df)
datatable(align_df)
ggplot(align_df, aes(x = "", y = percent_aligned)) +
  geom_boxplot(fill = "red") +
  labs(title =  "HISAT2 Alignment Percentages",
       y = "Alignment Percent (%)",x = "") 
```

QUESTION 6
```{r}
count_table <- gene_count_list$count

colnames(count_table) <- gsub("_sorted\\.bam$", "", colnames(count_table))


count_table <- count_table[rowSums(count_table[ , -1]) > 0, ]

datatable(count_table, 
              options = list(pageLength = 10), 
              caption = "Filtered Count Table")

```

QUESTION 7 
```{r}
comp <- systemPipeR::readComp("/Users/ipaz00/Library/R/arm64/4.4/library/systemPipeRdata/extdata/param/targetsPE.txt")
pairs<-comp[[1]]
p
results_list <- list()
for (pair in pairs) {
  groups <- unlist(strsplit(pair, "-"))
  g1 <- groups[1]
  g2 <- groups[2]
  comp_name <- paste(g1, "vs", g2)
  res <- DESeq2::results(dds2_results, contrast = c("Factor", g1, g2), alpha = 0.2)
  filtered_summary <- filter_and_count(res, comp_name)
  results_list[[comp_name]] <- filtered_summary
}

pairwise_summary <- do.call(rbind, results_list)

plot_data <- pairwise_summary %>%
  pivot_longer(cols = c(Up_regulated, Down_regulated),
               names_to = "Regulation",
               values_to = "Count") %>%
  mutate(Regulation = factor(Regulation, levels = c("Up_regulated", "Down_regulated")))

p2 <- ggplot(plot_data, aes(x = Comparison, y = Count, fill = Regulation)) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  labs(
    title = "Differentially Expressed Genes by Sample Comparison",
    subtitle = "Using dds2 (Factor-level), FC ≥ 2, alpha = 0.2",
    x = "Comparison",
    y = "Number of DE Genes",
    fill = "Regulation"
  ) +
  theme_minimal()
theme(
  plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
  plot.subtitle = element_text(hjust = 0.5, size = 12),
  axis.text = element_text(size = 10),
  axis.title = element_text(size = 12),
  legend.title = element_text(size = 11),
  legend.text = element_text(size = 10))

p2
```

